<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Applywizz Form</title>
    <script>
        // Environment Variable Placeholders (Injected during Vercel Build)
        window.ENV_SUPABASE_URL = "___SUPABASE_URL___";
        window.ENV_SUPABASE_KEY = "___SUPABASE_KEY___";
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #10b981;
            --glass-bg: rgba(255, 255, 255, 0.45);
            --glass-border: rgba(255, 255, 255, 0.3);
            --text: #0f172a;
            --text-muted: #475569;
            --bg-gradient: linear-gradient(135deg, #e0f2fe 0%, #dcfce7 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Roboto', 'Inter', sans-serif;
        }

        body {
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text);
            min-height: 100vh;
            padding: 2rem 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            overflow-x: hidden;
        }

        /* Animated Background Blobs for Glass Effect */
        body::before,
        body::after {
            content: '';
            position: fixed;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            z-index: -1;
            filter: blur(80px);
            opacity: 0.6;
            animation: move 20s infinite alternate;
        }

        body::before {
            background: #3b82f6;
            top: -100px;
            left: -100px;
        }

        body::after {
            background: #10b981;
            bottom: -100px;
            right: -100px;
            animation-delay: -10s;
        }

        @keyframes move {
            from {
                transform: translate(0, 0) scale(1);
            }

            to {
                transform: translate(100px, 100px) scale(1.2);
            }
        }

        .container {
            width: 100%;
            max-width: 770px;
            padding: 0 16px;
            z-index: 1;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(16px) saturate(180%);
            -webkit-backdrop-filter: blur(16px) saturate(180%);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12);
        }

        .card.main-card {
            border-top: 6px solid var(--primary);
            background: rgba(255, 255, 255, 0.65);
            padding: 24px 32px;
            /* Tighter vertical padding */
        }

        .card-title {
            font-size: 36px;
            font-weight: 700;
            letter-spacing: -0.02em;
            margin-bottom: 8px;
            background: linear-gradient(to right, #2563eb, #059669);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        #link-section {
            display: none;
        }

        #form-view {
            display: none;
        }

        .card-description {
            font-size: 16px;
            color: var(--text-muted);
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 12px;
        }

        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="tel"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            border: 1px solid var(--primary);
            /* Blue highlight outline base */
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 15px;
            color: var(--text);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid var(--primary);
            /* Double border effect using two shadows: one for the "gap" and one for the outer glow */
            box-shadow:
                0 0 0 2px rgba(255, 255, 255, 0.8),
                0 0 0 5px rgba(37, 99, 235, 0.4),
                0 8px 16px rgba(37, 99, 235, 0.1);
            transform: scale(1.01);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 28px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 15px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), #1e40af);
            color: white;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .btn-primary.success {
            background: linear-gradient(135deg, var(--secondary), #065f46);
            pointer-events: none;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.3);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.3);
            color: var(--primary);
            border: 1px solid var(--glass-border);
        }

        .btn-outline:hover {
            background: rgba(255, 255, 255, 0.6);
        }

        .btn-danger {
            background: rgba(255, 255, 255, 0.2);
            color: #ef4444;
        }

        .btn-danger:hover {
            background: #fee2e2;
        }

        .divider {
            height: 1px;
            background: var(--glass-border);
            margin: 20px 0;
        }

        .file-upload-box {
            border: 2px dashed var(--glass-border);
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            cursor: pointer;
            color: var(--primary);
            font-weight: 600;
            transition: all 0.2s;
        }

        .file-upload-box:hover {
            background: rgba(255, 255, 255, 0.4);
            border-color: var(--primary);
        }

        .toast {
            position: fixed;
            bottom: 32px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-size: 14px;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(10px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            flex-direction: column;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(37, 99, 235, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s infinite cubic-bezier(0.5, 0.1, 0.4, 0.9);
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container" id="nav-container" style="margin-top: 10px; margin-bottom: 0;">
        <div class="card"
            style="padding: 12px 24px; display: flex; justify-content: flex-end; align-items: center; gap: 12px; border-top: 4px solid var(--secondary);">
            <label style="margin: 0; font-size: 14px; font-weight: 600; color: var(--text-muted);">View Mode:</label>
            <select id="form-switcher"
                style="width: auto; padding: 8px 16px; border-radius: 8px; border: 1px solid var(--glass-border); background: var(--glass-bg); cursor: pointer;"
                onchange="if(this.value) window.location.href=this.value">
                <option value="index.html">First Form</option>
                <option value="second_form.html" selected>Second Form</option>
            </select>
        </div>
    </div>



    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-text" style="color: var(--text); margin-top: 16px; font-weight: 500;">Saving...</p>
    </div>

    <div class="container" id="builder-view">
        <div class="card main-card">
            <h1 class="card-title">Second Form Configuration</h1>
            <p class="card-description">Configure the second step of your workflow.</p>
            <div class="form-group" style="display: none;">
                <label>Business ID (Internal)</label>
                <input type="text" id="bid-input" value="AWL-6747">
            </div>
        </div>

        <div id="fields-container">
            <!-- Fields added here -->
        </div>

        <div style="display: flex; justify-content: space-between; margin-bottom: 24px;">
            <button class="btn btn-outline" id="add-field-btn">Add Question</button>
            <button class="btn btn-primary" id="create-form-btn">Generate Form Link</button>
        </div>

        <div class="card" id="link-section">
            <div class="section-title" style="color: var(--success);">Link Generated</div>
            <div
                style="display: flex; gap: 8px; align-items: center; background: white; padding: 12px; border-radius: 4px; border: 1px solid #ceead6;">
                <div id="generated-link"
                    style="flex: 1; font-size: 13px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                    http://...</div>
                <button class="btn btn-outline" id="copy-btn">Copy</button>
            </div>
        </div>
    </div>

    <!-- Live Form View -->
    <div class="container" id="form-view">
        <div class="card main-card">
            <h1 id="view-title" class="card-title">Form Title</h1>
            <p id="view-desc" class="card-description">Description</p>
            <div class="divider"></div>
            <p style="font-size: 12px; color: #d93025;">* Required</p>
        </div>
        <form id="dynamic-form">
            <div id="view-fields-container">
                <!-- Fields rendered here -->
            </div>
            <div style="display: flex; justify-content: flex-end; align-items: center; margin-top: 24px;">
                <button type="submit" class="btn btn-primary" id="submit-btn"
                    style="padding: 10px 40px;">Submit</button>
            </div>
        </form>
    </div>

    <div class="toast" id="toast">Link copied to clipboard</div>

    <script>
        // VERCEL CONFIGURATION
        // Placeholders that will be replaced by your Vercel Environment Variables
        // You can use a script in your package.json to replace these on deploy.
        const GLOBAL_SUPABASE_CONFIG = {
            url: window.ENV_SUPABASE_URL?.includes("___") ? "" : (window.ENV_SUPABASE_URL || ""),
            key: window.ENV_SUPABASE_KEY?.includes("___") ? "" : (window.ENV_SUPABASE_KEY || "")
        };

        const fieldsContainer = document.getElementById('fields-container');
        const addFieldBtn = document.getElementById('add-field-btn');
        const createFormBtn = document.getElementById('create-form-btn');
        const linkSection = document.getElementById('link-section');
        const generatedLinkInput = document.getElementById('generated-link');
        const copyBtn = document.getElementById('copy-btn');
        const builderView = document.getElementById('builder-view');
        const formView = document.getElementById('form-view');
        const dynamicForm = document.getElementById('dynamic-form');
        const toast = document.getElementById('toast');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const bidInput = document.getElementById('bid-input');

        let fieldCount = 0;
        let supabaseClient = null;
        let currentFormConfig = null;

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 4000);
        }

        // Initialize BID from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        if (bidInput) {
            bidInput.value = urlParams.get('bid') || "AWL-6747";
        }

        function createFieldRow(name = "", type = "text") {
            fieldCount++;
            const id = `field-${fieldCount}`;
            const row = document.createElement('div');
            row.className = 'card field-card';
            row.id = id;
            row.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 12px;">
                    <div class="form-group">
                        <label>Question</label>
                        <input type="text" placeholder="Question Title" class="field-name" value="${name}">
                    </div>
                    <div class="form-group">
                        <label>Type</label>
                        <select class="field-type" onchange="toggleOptions('${id}')">
                            <option value="text" ${type === 'text' ? 'selected' : ''}>Short answer</option>
                            <option value="textarea" ${type === 'textarea' ? 'selected' : ''}>Paragraph</option>
                            <option value="dropdown" ${type === 'dropdown' ? 'selected' : ''}>Dropdown</option>
                            <option value="radio" ${type === 'radio' ? 'selected' : ''}>Multiple choice (Radio)</option>
                            <option value="checkbox" ${type === 'checkbox' ? 'selected' : ''}>Checkboxes</option>
                            <option value="file" ${type === 'file' ? 'selected' : ''}>File upload</option>
                            <option value="email" ${type === 'email' ? 'selected' : ''}>Email</option>
                            <option value="number" ${type === 'number' ? 'selected' : ''}>Number</option>
                            <option value="date" ${type === 'date' ? 'selected' : ''}>Date</option>
                        </select>
                    </div>
                </div>
                
                <div class="options-container" id="opts-${id}" style="display: none; border-top: 1px dashed var(--border); padding-top: 12px; margin-bottom: 12px;">
                    <label style="font-size: 14px; color: var(--text-muted);">Options</label>
                    <div class="options-list">
                        <div class="opt-row" style="display: flex; gap: 8px; margin-bottom: 8px;">
                            <input type="text" class="opt-val" placeholder="Option 1" style="flex: 1;">
                            <button class="btn btn-danger" style="padding: 4px 12px;" onclick="this.parentElement.remove()">×</button>
                        </div>
                    </div>
                    <button class="btn btn-outline" style="font-size: 12px; padding: 4px 12px;" onclick="addOption('${id}')">+ Add option</button>
                </div>

                <div style="display: flex; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="removeField('${id}')">Remove</button>
                </div>
            `;
            fieldsContainer.appendChild(row);
        }

        function toggleOptions(id) {
            const card = document.getElementById(id);
            const type = card.querySelector('.field-type').value;
            const container = document.getElementById(`opts-${id}`);
            const isChoice = ['dropdown', 'radio', 'checkbox'].includes(type);
            container.style.display = isChoice ? 'block' : 'none';
        }

        function addOption(id) {
            const list = document.querySelector(`#opts-${id} .options-list`);
            const div = document.createElement('div');
            div.className = 'opt-row';
            div.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
            div.innerHTML = `
                <input type="text" class="opt-val" placeholder="New option" style="flex: 1;">
                <button class="btn btn-danger" style="padding: 4px 12px;" onclick="this.parentElement.remove()">×</button>
            `;
            list.appendChild(div);
        }

        function removeField(id) { document.getElementById(id).remove(); }

        addFieldBtn.addEventListener('click', createFieldRow);

        createFormBtn.addEventListener('click', () => {
            const fieldCards = document.querySelectorAll('.field-card');
            const fields = [];

            fieldCards.forEach((card) => {
                const name = card.querySelector('.field-name').value;
                const type = card.querySelector('.field-type').value;
                if (!name) return;

                const fieldObj = { n: name, t: type }; // Short keys
                if (['dropdown', 'radio', 'checkbox'].includes(type)) {
                    const optInputs = card.querySelectorAll('.opt-val');
                    fieldObj.o = Array.from(optInputs).map(i => i.value).filter(v => v !== "");
                }
                fields.push(fieldObj);
            });

            if (fields.length === 0) { alert("Please add at least one question."); return; }

            // Minimalist config to keep URL short
            const config = { f: fields };
            const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(config))));

            // DYNAMIC BID (from UI input)
            const bid = bidInput.value || "AWL-6747";
            const bHash = btoa(bid); // Keep padding for robustness

            const shortUrl = `${window.location.origin}${window.location.pathname}?c=${encoded}&b=${encodeURIComponent(bHash)}`;

            generatedLinkInput.textContent = shortUrl;
            linkSection.style.display = 'block';

            // Button Animation
            const originalText = createFormBtn.innerHTML;
            createFormBtn.innerHTML = 'Generated ✓';
            createFormBtn.classList.add('success');

            setTimeout(() => {
                createFormBtn.innerHTML = originalText;
                createFormBtn.classList.remove('success');
            }, 3000);
        });

        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(generatedLinkInput.textContent).then(() => {
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            });
        });

        async function initApp() {
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('c'); // Use compact param 'c'

            // Initialize Supabase Client
            const finalUrl = GLOBAL_SUPABASE_CONFIG.url;
            const finalKey = GLOBAL_SUPABASE_CONFIG.key;
            if (finalUrl && finalKey && !finalUrl.includes('PLACEHOLDER') && finalUrl !== "") {
                supabaseClient = supabase.createClient(finalUrl, finalKey);
            }

            if (encoded) {
                if (document.getElementById('nav-container')) document.getElementById('nav-container').style.display = 'none';
                try {
                    const raw = atob(encoded.replace(/ /g, '+'));
                    try {
                        currentFormConfig = JSON.parse(decodeURIComponent(escape(raw)));
                    } catch (e) {
                        currentFormConfig = JSON.parse(raw);
                    }

                    // FETCH BID DYNAMICALLY from table if 'lid' or 'id' is provided
                    const lid = params.get('lid') || params.get('id');
                    if (lid && supabaseClient) {
                        try {
                            const { data, error } = await supabaseClient.from('leads').select('business_id').eq('id', lid).single();
                            if (data && data.business_id) {
                                window.DYNAMIC_BID = data.business_id;
                                console.log("Dynamic BID loaded:", window.DYNAMIC_BID);
                            }
                        } catch (err) { console.error("Lookup error", err); }
                    }

                    renderForm(currentFormConfig);
                } catch (e) { console.error("Config error", e); }
            } else {
                createFieldRow("Email", "email");
            }
        }

        function renderForm(config) {
            console.log("Rendering Form with config:", config);
            builderView.style.display = 'none';
            formView.style.display = 'block';
            document.getElementById('view-title').textContent = "Step 2: Final Submission";
            document.getElementById('view-desc').textContent = "Please complete the final details.";

            const container = document.getElementById('view-fields-container');
            container.innerHTML = '';

            const questions = (Array.isArray(config.f) ? config.f : (Array.isArray(config.qs) ? config.qs : []));
            if (questions.length === 0) {
                console.warn("No questions found in config to render.");
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const prefilledEmail = urlParams.get('email') || "";

            questions.forEach((field, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.padding = '24px';
                card.style.marginBottom = '20px';
                card.style.background = 'white'; // Solid white
                card.style.boxShadow = '0 4px 12px rgba(0,0,0,0.05)';

                const label = field.n || field.l || "Question";
                card.innerHTML = `<label style="margin-bottom: 15px; display: block; font-weight: 600; font-size: 16px; color: var(--text);">${label} <span style="color: #ef4444;">*</span></label>`;

                const fieldId = `field_${index}`;
                const type = field.t;
                const options = field.o || [];
                const value = (label.toLowerCase().includes("email") ? prefilledEmail : "");

                if (type === 'textarea') {
                    const el = document.createElement('textarea');
                    el.name = fieldId;
                    el.placeholder = 'Your answer';
                    el.required = true;
                    el.style.background = "#f8fafc";
                    card.appendChild(el);
                } else if (type === 'dropdown') {
                    const el = document.createElement('select');
                    el.name = fieldId;
                    el.required = true;
                    el.style.background = "#f8fafc";
                    el.innerHTML = '<option value="" disabled selected>Choose</option>';
                    options.forEach(opt => {
                        const o = document.createElement('option');
                        o.value = opt;
                        o.textContent = opt;
                        el.appendChild(o);
                    });
                    card.appendChild(el);
                } else if (type === 'radio') {
                    options.forEach(opt => {
                        const wrapper = document.createElement('div');
                        wrapper.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;';
                        wrapper.innerHTML = `
                            <input type="radio" name="${fieldId}" value="${opt}" id="${fieldId}_${opt}" required style="width: 18px; height: 18px;">
                            <label for="${fieldId}_${opt}" style="margin: 0; font-size: 15px; font-weight: 400; cursor: pointer;">${opt}</label>
                        `;
                        card.appendChild(wrapper);
                    });
                } else if (type === 'checkbox') {
                    options.forEach(opt => {
                        const wrapper = document.createElement('div');
                        wrapper.style.cssText = 'display: flex; align-items: center; gap: 10px; margin-bottom: 12px; cursor: pointer;';
                        wrapper.innerHTML = `
                            <input type="checkbox" name="${fieldId}" value="${opt}" id="${fieldId}_${opt}" style="width: 18px; height: 18px;">
                            <label for="${fieldId}_${opt}" style="margin: 0; font-size: 15px; font-weight: 400; cursor: pointer;">${opt}</label>
                        `;
                        card.appendChild(wrapper);
                    });
                } else if (type === 'file') {
                    const wrapper = document.createElement('div');
                    wrapper.className = 'file-upload-box';
                    wrapper.innerHTML = `<span>Add file</span>`;
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.style.display = 'none';
                    input.name = fieldId;
                    input.required = true;
                    wrapper.onclick = () => input.click();
                    input.onchange = () => { wrapper.querySelector('span').textContent = input.files[0].name; };
                    card.appendChild(wrapper);
                    card.appendChild(input);
                } else {
                    const el = document.createElement('input');
                    el.type = type;
                    el.name = fieldId;
                    el.value = value;
                    el.placeholder = 'Your answer';
                    el.required = true;
                    el.style.background = "#f8fafc";
                    card.appendChild(el);
                }

                container.appendChild(card);
            });
            console.log("Form rendering complete.");
        }

        dynamicForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const formData = new FormData(dynamicForm);
            let userEmail = formData.get('user_email');

            if (!userEmail) {
                const questions = (currentFormConfig.f || currentFormConfig.qs || []);
                const emailIdx = questions.findIndex(q => (q.n || q.l || "").toLowerCase().includes("email"));
                if (emailIdx !== -1) userEmail = formData.get(`field_${emailIdx}`);
            }

            if (!userEmail) { alert("Error: Email is required."); return; }

            if (!supabaseClient) { alert("Error: Supabase not configured."); return; }

            loadingOverlay.style.display = 'flex';
            const results = {};
            const questions = currentFormConfig.f || currentFormConfig.qs || [];

            try {
                // 1. Find latest lead by email
                let bid = "";
                const bParam = new URLSearchParams(window.location.search).get('b');
                if (bParam) { try { bid = atob(decodeURIComponent(bParam).replace(/ /g, '+')); } catch (e) { bid = bParam; } }

                const query = supabaseClient.from('leads').select('id, extra_data').eq('email', userEmail);
                if (bid) query.eq('business_id', bid);

                const { data: leads, error: fetchError } = await query.order('created_at', { ascending: false }).limit(1);

                if (fetchError) throw new Error(`Fetch Error: ${fetchError.message}`);
                if (!leads || leads.length === 0) {
                    showToast("we could found the email in the try with another mail id");
                    return;
                }

                const lead = leads[0];

                // 2. Process Form Results
                for (let i = 0; i < questions.length; i++) {
                    const q = questions[i];
                    const label = q.n || q.l || "Question";
                    const fieldName = `field_${i}`;

                    if (q.t === 'checkbox') {
                        results[label] = formData.getAll(fieldName);
                    } else if (q.t === 'file') {
                        const val = formData.get(fieldName);
                        if (val && val.size > 0) {
                            const path = `${bid || 'global'}/${Date.now()}-${val.name}`;
                            const { error: uploadError } = await supabaseClient.storage
                                .from('files_by_form-LEADS')
                                .upload(path, val, { upsert: true });

                            if (uploadError) throw new Error(`Storage Error: ${uploadError.message}`);
                            results[label] = (await supabaseClient.storage.from('files_by_form-LEADS').getPublicUrl(path)).data.publicUrl;
                        }
                    } else {
                        results[label] = formData.get(fieldName);
                    }
                }

                // 3. Update extra_data (Merging under Form2)
                const existingExtra = lead.extra_data || {};
                const updatedExtra = {
                    ...existingExtra,
                    Form2: {
                        ...(existingExtra.Form2 || {}),
                        ...results,
                        completed_at: new Date().toISOString()
                    }
                };

                const { error: dbError } = await supabaseClient.from('leads').update({ extra_data: updatedExtra }).eq('id', lead.id);
                if (dbError) throw new Error(`Database Error: ${dbError.message}`);

                document.getElementById('form-view').innerHTML = `<div class="card"><h1 class="card-title">Form Submission</h1><p class="card-description">Your response has been recorded.</p></div>`;
            } catch (err) { alert("Submission failed: " + err.message); }
            finally { loadingOverlay.style.display = 'none'; }
        });

        initApp();
    </script>
</body>

</html>